<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="520px" preserveAspectRatio="none" style="width:1885px;height:520px;background:#F5F5F5;" version="1.1" viewBox="0 0 1885 520" width="1885px" zoomAndPan="magnify"><defs/><g><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="355" x="766" y="26.708">Sewing Motor Motion Control Sequence</text><rect fill="#FFFFFF" height="240.1953" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="418" y="140.8125"/><rect fill="#FFFFFF" height="122.5313" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="819" y="214.2109"/><rect fill="#FFFFFF" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="997" y="243.3438"/><rect fill="#F5F5F5" height="344.7266" style="stroke: #000000; stroke-width: 2.0;" width="1861" x="13" y="102.5469"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="90" x2="90" y1="85.5469" y2="464.2734"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="423" x2="423" y1="85.5469" y2="464.2734"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="823.5" x2="823.5" y1="85.5469" y2="464.2734"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1001.5" x2="1001.5" y1="85.5469" y2="464.2734"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1140.5" x2="1140.5" y1="85.5469" y2="464.2734"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1270.5" x2="1270.5" y1="85.5469" y2="464.2734"/><rect fill="#FEFECE" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="134" x="23" y="37.9531"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="120" x="30" y="57.9482">NeedleSync Loop</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="102" x="39" y="74.2451">(needlesync.c)</text><rect fill="#FEFECE" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="134" x="23" y="463.2734"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="120" x="30" y="483.2686">NeedleSync Loop</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="102" x="39" y="499.5654">(needlesync.c)</text><rect fill="#FEFECE" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="206" x="320" y="37.9531"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="166" x="340" y="57.9482">Sewing Machine Control</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="192" x="327" y="74.2451">(sewing_machine_control.c)</text><rect fill="#FEFECE" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="206" x="320" y="463.2734"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="166" x="340" y="483.2686">Sewing Machine Control</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="192" x="327" y="499.5654">(sewing_machine_control.c)</text><rect fill="#FEFECE" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="189" x="729.5" y="37.9531"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="770" y="57.9482">S-curve Planner</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="175" x="736.5" y="74.2451">(scurve_step_projector.c)</text><rect fill="#FEFECE" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="189" x="729.5" y="463.2734"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="770" y="483.2686">S-curve Planner</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="175" x="736.5" y="499.5654">(scurve_step_projector.c)</text><rect fill="#FEFECE" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="121" x="941.5" y="37.9531"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="87" x="958.5" y="57.9482">Kalman Filter</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="107" x="948.5" y="74.2451">(kalman_filter.c)</text><rect fill="#FEFECE" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="121" x="941.5" y="463.2734"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="87" x="958.5" y="483.2686">Kalman Filter</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="107" x="948.5" y="499.5654">(kalman_filter.c)</text><rect fill="#FEFECE" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="137" x="1072.5" y="37.9531"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="99" x="1091.5" y="57.9482">Wrap Manager</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="123" x="1079.5" y="74.2451">(wrap_manager.c)</text><rect fill="#FEFECE" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="137" x="1072.5" y="463.2734"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="99" x="1091.5" y="483.2686">Wrap Manager</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="123" x="1079.5" y="499.5654">(wrap_manager.c)</text><rect fill="#FEFECE" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="103" x="1219.5" y="37.9531"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="89" x="1226.5" y="57.9482">HAL Stepgen</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="80" x="1231" y="74.2451">stepgen.01</text><rect fill="#FEFECE" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="103" x="1219.5" y="463.2734"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="89" x="1226.5" y="483.2686">HAL Stepgen</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="80" x="1231" y="499.5654">stepgen.01</text><rect fill="#FFFFFF" height="240.1953" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="418" y="140.8125"/><rect fill="#FFFFFF" height="122.5313" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="819" y="214.2109"/><rect fill="#FFFFFF" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="997" y="243.3438"/><path d="M13,102.5469 L90,102.5469 L90,109.5469 L80,119.5469 L13,119.5469 L13,102.5469 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="344.7266" style="stroke: #000000; stroke-width: 2.0;" width="1861" x="13" y="102.5469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="32" x="28" y="115.6138">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="107" x="105" y="114.7573">[Each servo tick]</text><polygon fill="#A80036" points="406,136.8125,416,140.8125,406,144.8125,410,140.8125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="90" x2="412" y1="140.8125" y2="140.8125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="99.5" y="135.7466">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="296" x="112.5" y="135.7466">process_sewing_machine_dt(needle_state, dt)</text><polygon fill="#A80036" points="812,181.0781,822,185.0781,812,189.0781,816,185.0781" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="428" x2="818" y1="185.0781" y2="185.0781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="510" y="172.4458">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="219" x="523" y="164.8794">mcsp_move_to_abs(target, limits)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="551.5" y="180.0122">[when move-up/stitching]</text><path d="M829,158.3789 L829,183.3789 L1057,183.3789 L1057,168.3789 L1047,158.3789 L829,158.3789 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1047,158.3789 L1047,168.3789 L1057,168.3789 L1047,158.3789 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="835" y="175.4458">High-level controller posts a new</text><path d="M829,158.3789 L829,183.3789 L1099,183.3789 L1099,168.3789 L1089,158.3789 L829,158.3789 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1089,158.3789 L1089,168.3789 L1099,168.3789 L1089,158.3789 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="249" x="835" y="175.4458">jerk-limited position goal when needed.</text><polygon fill="#A80036" points="807,210.2109,817,214.2109,807,218.2109,811,214.2109" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="428" x2="813" y1="214.2109" y2="214.2109"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="437.5" y="209.145">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="359" x="450.5" y="209.145">mcsp_integrate_feedback(motor_pos, vel, t_meas, now)</text><polygon fill="#A80036" points="985,239.3438,995,243.3438,985,247.3438,989,243.3438" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="829" x2="991" y1="243.3438" y2="243.3438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="838.5" y="238.2778">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="851.5" y="238.2778">mckf_kf_integrate(...)</text><polygon fill="#A80036" points="840,268.4766,830,272.4766,840,276.4766,836,272.4766" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="834" x2="1001" y1="272.4766" y2="272.4766"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="872" y="267.4106">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="74" x="885" y="267.4106">state(p,v,a)</text><polygon fill="#A80036" points="1129,297.6094,1139,301.6094,1129,305.6094,1133,301.6094" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="829" x2="1135" y1="301.6094" y2="301.6094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="918" y="296.5435">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="121" x="931" y="296.5435">unwrap(command)</text><polygon fill="#A80036" points="1259,332.7422,1269,336.7422,1259,340.7422,1263,336.7422" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="824" x2="1265" y1="336.7422" y2="336.7422"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="920" y="331.6763">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="242" x="933" y="331.6763">stp_set_sewmotor_pos_cmd(position)</text><path d="M1276,314.6094 L1276,339.6094 L1563,339.6094 L1563,324.6094 L1553,314.6094 L1276,314.6094 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1553,314.6094 L1553,324.6094 L1563,324.6094 L1553,314.6094 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="266" x="1282" y="331.6763">The sampled position command is written</text><path d="M1276,314.6094 L1276,339.6094 L1557,339.6094 L1557,324.6094 L1547,314.6094 L1276,314.6094 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1547,314.6094 L1547,324.6094 L1557,324.6094 L1547,314.6094 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="260" x="1282" y="331.6763">to stepgen.01 to drive the sewing motor.</text><polygon fill="#A80036" points="101,377.0078,91,381.0078,101,385.0078,97,381.0078" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="95" x2="422" y1="381.0078" y2="381.0078"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="175.5" y="368.3755">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="188.5" y="360.8091">updated sewmac_state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="125" x="200.5" y="375.9419">(time-to-up, safety)</text><polygon fill="#A80036" points="1259,406.1406,1269,410.1406,1259,414.1406,1263,410.1406" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="90" x2="1265" y1="410.1406" y2="410.1406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="567" y="405.0747">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="214" x="580" y="405.0747">read stepgen_sewmotor_pos_fb()</text><polygon fill="#A80036" points="411,435.2734,421,439.2734,411,443.2734,415,439.2734" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="90" x2="417" y1="439.2734" y2="439.2734"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="147.5" y="434.2075">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="196" x="169.5" y="434.2075">update sewmotor_fb_error flag</text><!--MD5=[2776e4bef518663c071fc4d7f758117a]
@startuml
skinparamlocked backgroundColor #f5f5f5
skinparam shadowing false
skinparam sequenceMessageAlign center
title Sewing Motor Motion Control Sequence

autonumber

participant "NeedleSync Loop\n(needlesync.c)" as Loop
participant "Sewing Machine Control\n(sewing_machine_control.c)" as SewMac
participant "S-curve Planner\n(scurve_step_projector.c)" as Planner
participant "Kalman Filter\n(kalman_filter.c)" as Kalman
participant "Wrap Manager\n(wrap_manager.c)" as WrapMgr
participant "HAL Stepgen\nstepgen.01" as Stepgen

loop Each servo tick
  Loop -> SewMac : process_sewing_machine_dt(needle_state, dt)
  activate SewMac
  SewMac -> Planner : mcsp_move_to_abs(target, limits)\n[when move-up/stitching]
  note right: High-level controller posts a new
  note right: jerk-limited position goal when needed.
  SewMac -> Planner : mcsp_integrate_feedback(motor_pos, vel, t_meas, now)
  activate Planner
  Planner -> Kalman : mckf_kf_integrate(...)
  activate Kalman
  Kalman - -> Planner : state(p,v,a)
  deactivate Kalman
  Planner -> WrapMgr : unwrap(command)
  deactivate WrapMgr
  Planner -> Stepgen : stp_set_sewmotor_pos_cmd(position)
  note right: The sampled position command is written
  note right: to stepgen.01 to drive the sewing motor.
  deactivate Planner
  SewMac -> Loop : updated sewmac_state\n(time-to-up, safety)
  deactivate SewMac
  Loop -> Stepgen : read stepgen_sewmotor_pos_fb()
  Loop -> SewMac : update sewmotor_fb_error flag
end

@enduml

PlantUML version 1.2020.02(Sun Mar 01 05:22:07 EST 2020)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 17.0.16+8-Debian-1deb12u1
Operating System: Linux
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>